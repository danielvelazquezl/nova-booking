<%= form_with(model: booking, local: true) do |form| %>

  <div class="content-heading">Reserva</div>
  <div align="center">
    <div class="col-7">
      <div class="card card-default">
        <fieldset style="margin: 0; border: 0; padding: 0;" class="card-body">
          <div class="row ocultar" align="left">
            <div class="col-md-8">
              <div class="card-body">
                <div class="form-group col-10">
                  <label>Nombre y Apellido *</label>
                  <% if user_signed_in?%>
                    <%= form.text_field :client_name, class: "form-control",value: current_user.name + " "+current_user.last_name, required: "required" %>
                  <%else %>
                    <%= form.text_field :client_name, class: "form-control", required: "required" %>
                  <%end %>
                </div>
              </div>
              <div class="card-body">
                <div class="form-group col-10">
                  <label>Correo *</label>
                  <% if user_signed_in?%>
                    <%= form.text_field :client_email, class: "form-control", required: "required", value: current_user.email,:readonly => true %>
                  <%else %>
                    <%= form.email_field :client_email, class: "form-control", required: "required" %>
                  <%end %>
                </div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card-body">
                <div class="form-group  ">
                  <label>Desde</label>
                  <%= form.date_field :date_start, class: "form-control", required: "required",:readonly => true %>
                </div>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label>Hasta </label>
                  <%= form.date_field :date_end, class: "form-control", required: "required",:readonly => true %>
                </div>
              </div>
            </div>
          </div>
          <br>
          <div class="col-11">
            <table class="table">
              <thead class="table-primary">
              <tr>
                <th>Tipo de habitaci√≥n</th>
                <th>Capacidad</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Total noches</th>
                <th>Subtotal</th>
              </tr>
              </thead>
              <tbody>
              <% subtotal = 0 %>
              <% i = 0 %>
              <%= form.fields_for :booking_details, booking.booking_details do |f| %>
                <tr>
                  <td><%=Room.room_type_for(f.object.room_id)%></td>
                  <td><%=Room.room_capacity_for(f.object.room_id)%></td>
                  <td><%=f.object.quantity %></td>
                  <td><%=number_to_currency(f.object.subtotal / f.object.quantity , :unit => "Gs", :separator => ".", :precision => 0) %></td>
                  <td><%=diff %></td>
                  <td><%=number_to_currency( f.object.subtotal*diff, :unit => "Gs", :separator => ".", :precision => 0) %></td>
                  <%= f.hidden_field :room_id %>
                  <%= f.hidden_field :quantity %>
                  <%= f.hidden_field :subtotal %>
                  <%= f.hidden_field :booking_id %>
                  <% subtotal+= f.object.subtotal %>
                </tr>

                <% f.object.offer_discounts.each do |ff| %>
                    <%= hidden_field_tag "booking[booking_details_attributes][#{f.object.id.nil? ? i : f.object.id}][offer_discounts][][quantity_days]", ff['quantity_days'] %>
                    <%= hidden_field_tag "booking[booking_details_attributes][#{f.object.id.nil? ? i : f.object.id}][offer_discounts][][discount]", ff['discount'] %>
                    <%= hidden_field_tag "booking[booking_details_attributes][#{f.object.id.nil? ? i : f.object.id}][offer_discounts][][description]", ff['description'] %>
                <% end %>
              <% i+=1 %>
              <% end %>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                  <b><%= number_to_currency( subtotal*diff, :unit => "Gs", :separator => ".", :precision => 0) %></b>
                </td>
              </tr>
              <% booking.booking_details.each_with_index do |f, i| %>
                <% if i==0 && booking.discount > 0 %>
                  <thead class="table-primary">
                  <tr>
                    <th>Descuentos</th>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>Habitacion</td>
                    <td>Precio unitario por cantidad</td>
                    <td>Descripcion de oferta</td>
                    <td>Dias con oferta</td>
                    <td>Descuento(%)</td>
                    <td>Subtotal</td>
                  </tr>
                  </thead>
                <% end %>
                <% f.offer_discounts.each do |ff |%>
                  <tr>
                    <td><%=Room.room_type_for(f.room_id)%></td>
                    <td><%=number_to_currency( f.subtotal, :unit => "Gs", :separator => ".", :precision => 0) %></td>
                    <td><%=ff['description']%></td>
                    <td><%=ff['quantity_days'] %></td>
                    <td><%=ff['discount'] %></td>
                    <td><%=number_to_currency(((f.subtotal*ff['quantity_days'].to_i)*(ff['discount'].to_i)/100), :unit => "Gs", :separator => ".", :precision => 0) %></td>
                  </tr>
                <% end %>
              <% end %>
              <% if booking.discount > 0 %>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                  <b><%= number_to_currency(booking.discount, :unit => "Gs", :separator => ".", :precision => 0) %></b>
                </td>
              </tr>
              <% end %>

              <tr class="thead-light">
                <th><b>Total:</b></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>
                  <b> <%= number_to_currency( form.object.total_amount, :unit => "Gs", :separator => ".", :precision => 0) %></b>
                  <%= form.hidden_field :total_amount %>
                  <%= form.hidden_field :discount %>
                  <%= form.hidden_field :date_creation %>
                </th>
              </tr>
              </tbody>
            </table>
          </div>
        </fieldset>
        <fieldset>
          <br/>
          <div align="right">
            <div class="col-md-4">
              <%= form.hidden_field :estate_id %>
              <%= form.submit 'Reservar', class: "btn btn-success" %>
            </div>
          </div>
        </fieldset>
      </div>
    </div>
  </div>


<% end %>